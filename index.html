<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小說閱讀器</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            line-height: 1.6;
            padding: 10px;
            max-width: 100%;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            font-size: 24px;
        }
        #content {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            font-size: 18px;
        }
        #content p {
            cursor: pointer;
        }
        #content p:hover {
            background-color: #e0e0e0;
        }
        #controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        button, select, input[type="file"] {
            font-size: 16px;
            padding: 5px 10px;
            margin: 5px;
        }
        #bookmarkInfo {
            margin-top: 10px;
        }
        #fileSelect {
            width: 200px;
            margin-right: 10px;
        }
        /* 在现有样式后添加 */
        body.dark-mode {
            background-color: #333;
            color: #f0f0f0;
        }
        body.dark-mode #content {
            background-color: #444;
        }
        body.dark-mode #content p:hover {
            background-color: #555;
        }
        #version {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1 id="pageTitle">小說閱讀 <span id="version"></span></h1>
    <input type="file" id="fileInput" accept=".txt,.md" multiple style="display: none;">
    <select id="fileSelect">
        <option value="">選擇檔案...</option>
    </select>
    <button id="addFiles">添加檔案</button>
    <button id="clearFiles">清空檔案列表</button>
    <div id="bookmarkInfo"></div>
    <div id="content">
        請選擇一個文件開始閱讀...
    </div>
    <div id="controls">
        <button id="playPause">播放 / 暫停</button>
        <select id="voiceSelect"></select>
        <button id="jumpToBookmark">跳轉至書籤</button>
        <input type="range" id="speedControl" min="0.5" max="2" step="0.1" value="1">
        <span id="speedValue">1x</span>
        <!-- 其他控制按钮 -->
        <button id="darkModeToggle">夜間模式</button>
        <button id="decreaseFont">A-</button>
        <button id="increaseFont">A+</button>
    </div>

    <script>
        let speech = null;
        let isPaused = false;
        let isPlaying = false; // 添加这行
        let currentIndex = 0;
        let contentParagraphs = [];
        let voices = [];
        let currentFile = '';
        let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || {};
        let currentSpeed = parseFloat(localStorage.getItem('speechRate')) || 1;
        let fileList = [];

        // 在脚本开头添加版本号变量
        let version = localStorage.getItem('appVersion') || '1.0.0';
        let lastCodeHash = localStorage.getItem('lastCodeHash') || '';

        // 计算代码哈希的函数
        async function calculateCodeHash() {
            const response = await fetch(window.location.href);
            const code = await response.text();
            const encoder = new TextEncoder();
            const data = encoder.encode(code);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // 更新版本号的函数
        function updateVersion() {
            let [major, minor, patch] = version.split('.').map(Number);
            patch += 1;
            if (patch > 9) {
                patch = 0;
                minor += 1;
            }
            if (minor > 9) {
                minor = 0;
                major += 1;
            }
            version = `${major}.${minor}.${patch}`;
            localStorage.setItem('appVersion', version);
            document.getElementById('version').textContent = `v${version}`;
        }

        // 检查并更新版本的函数
        async function checkAndUpdateVersion() {
            const currentHash = await calculateCodeHash();
            if (currentHash !== lastCodeHash) {
                updateVersion();
                lastCodeHash = currentHash;
                localStorage.setItem('lastCodeHash', currentHash);
            }
            document.getElementById('version').textContent = `v${version}`;
        }

        // 在文档加载完成后检查并更新版本号
        document.addEventListener('DOMContentLoaded', (event) => {
            checkAndUpdateVersion();
            // ... 其他初始化代码 ...
        });

        // 替换现有的 loadVoices 函数
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            let voiceSelect = document.getElementById("voiceSelect");
            voiceSelect.innerHTML = "";
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // 获取用户的语言环境
            const userLanguage = navigator.language || navigator.userLanguage;
            const languageCode = userLanguage.split('-')[0]; // 获取主要语言代码

            console.log("User language:", userLanguage);
            console.log("Available voices:", voices);

            // 添加"系统默认"选项
            let defaultOption = document.createElement("option");
            defaultOption.value = "default";
            defaultOption.innerHTML = "系统默认语音";
            voiceSelect.appendChild(defaultOption);
            
            voices.forEach((voice, i) => {
                // 检查语音是否匹配用户的语言环境
                if (voice.lang.startsWith(languageCode)) {
                    let option = document.createElement("option");
                    option.value = i;
                    option.innerHTML = voice.name + ' (' + voice.lang + ')';
                    voiceSelect.appendChild(option);
                }
            });
            
            // 如果没有匹配的语音，添加所有可用的语音
            if (voiceSelect.options.length === 1) {
                voices.forEach((voice, i) => {
                    let option = document.createElement("option");
                    option.value = i;
                    option.innerHTML = voice.name + ' (' + voice.lang + ')';
                    voiceSelect.appendChild(option);
                });
            }
            
            if (voiceSelect.options.length === 1) {
                let option = document.createElement("option");
                option.value = "";
                option.innerHTML = "没有可用的语音";
                voiceSelect.appendChild(option);
            }

            if (isIOS) {
                let iosNote = document.createElement("p");
                iosNote.innerHTML = "提示：iOS 用户如果希望使用系统语音（如月、波波、甜甜等），请使用系统的辅助功能。在设置中开启 '辅助功能' > '朗读内容'，然后在网页上选择文本并使用系统提供的朗读功能。";
                document.getElementById("content").insertAdjacentElement('beforebegin', iosNote);
            }

            console.log("Voices loaded:", voiceSelect.options.length);
        }

        // 修改 speak 函数
        function speak(text) {
            console.log("Attempting to speak:", text);
            if (speech) {
                speechSynthesis.cancel();
            }

            const selectedVoice = document.getElementById("voiceSelect").value;
            
            speech = new SpeechSynthesisUtterance(text);
            if (selectedVoice !== "default") {
                let voice = voices[selectedVoice];
                if (voice) {
                    speech.voice = voice;
                    speech.lang = voice.lang;
                }
            }
            speech.rate = currentSpeed;
            speech.onstart = () => {
                console.log("Speech started");
                isPlaying = true;
                isPaused = false;
                updatePlayPauseButton();
            };
            speech.onend = () => {
                console.log("Speech ended");
                if (!isPaused) {
                    currentIndex++;
                    if (currentIndex < contentParagraphs.length) {
                        speak(contentParagraphs[currentIndex].textContent);
                    } else {
                        isPlaying = false;
                        speech = null;
                        isPaused = false;
                        updatePlayPauseButton();
                    }
                }
            };
            speech.onpause = () => {
                console.log("Speech paused");
                isPaused = true;
                isPlaying = false;
                updatePlayPauseButton();
            };
            speech.onresume = () => {
                console.log("Speech resumed");
                isPaused = false;
                isPlaying = true;
                updatePlayPauseButton();
            };
            speech.onerror = (event) => {
                if (event.error !== 'interrupted') {
                    console.error("Speech error:", event.error);
                }
                isPlaying = false;
                isPaused = false;
                updatePlayPauseButton();
            };
            speechSynthesis.speak(speech);
            updateBookmark();
        }

        function updateBookmark() {
            if (currentFile && currentIndex < contentParagraphs.length) {
                bookmarks[currentFile] = {
                    index: currentIndex,
                    text: contentParagraphs[currentIndex].textContent.substring(0, 20) + '...'
                };
                localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
                updateBookmarkInfo();
            }
        }

        function updateBookmarkInfo() {
            const bookmarkInfo = document.getElementById('bookmarkInfo');
            if (bookmarks[currentFile]) {
                bookmarkInfo.textContent = `當前書籤: ${bookmarks[currentFile].text}`;
            } else {
                bookmarkInfo.textContent = '沒有書籤';
            }
        }

        function jumpToBookmark() {
            if (bookmarks[currentFile]) {
                currentIndex = bookmarks[currentFile].index;
                speak(contentParagraphs[currentIndex].textContent);
            }
        }

        function updateFileSelect() {
            const fileSelect = document.getElementById('fileSelect');
            fileSelect.innerHTML = '<option value="">選擇檔案...</option>';
            fileList.forEach((file, index) => {
                let option = document.createElement('option');
                option.value = index;
                option.textContent = file.name.replace(/\.[^/.]+$/, ""); // 移除文件擴展名
                fileSelect.appendChild(option);
            });
            localStorage.setItem('fileList', JSON.stringify(fileList.map(f => ({name: f.name, lastModified: f.lastModified}))));
        }

        document.getElementById('addFiles').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (event) => {
            const newFiles = Array.from(event.target.files);
            newFiles.forEach(newFile => {
                const existingIndex = fileList.findIndex(f => f.name === newFile.name);
                if (existingIndex !== -1) {
                    fileList[existingIndex] = newFile; // 替換同名文件
                } else {
                    fileList.push(newFile);
                }
            });
            updateFileSelect();
        });

        document.getElementById('clearFiles').addEventListener('click', () => {
            fileList = [];
            updateFileSelect();
            document.getElementById('content').innerHTML = '請選擇一個文件開始閱讀...';
            if (speech) {
                speechSynthesis.cancel();
                speech = null;
            }
            localStorage.removeItem('lastSelectedFile');
            document.getElementById('fileInput').value = ''; // 重置文件輸入
        });

        document.getElementById('fileSelect').addEventListener('change', (event) => {
            if (speech) {
                speechSynthesis.cancel();
                speech = null;
            }
            const selectedIndex = event.target.value;
            if (selectedIndex !== '') {
                const selectedFile = fileList[selectedIndex];
                currentFile = selectedFile.name;
                if (selectedFile.size > 0) {
                    loadContent(selectedFile);
                } else {
                    // 如果文件大小为 0，尝试从 localStorage 加载内容
                    const savedContent = localStorage.getItem('fileContent_' + currentFile);
                    if (savedContent) {
                        document.getElementById('content').innerHTML = marked.parse(savedContent);
                        setupParagraphListeners();
                        updateBookmarkInfo();
                    } else {
                        document.getElementById('content').innerHTML = '请重新选择文件以加载内容。';
                    }
                }
                localStorage.setItem('lastSelectedFile', currentFile);
            }
        });

        // 修改 playPause 函数
        function playPause() {
            console.log("PlayPause called. isPlaying:", isPlaying, "isPaused:", isPaused);
            if (!isPlaying && !speech) {
                if (contentParagraphs.length > 0) {
                    speak(contentParagraphs[currentIndex].textContent);
                } else {
                    console.log("No content to play");
                }
            } else if (isPlaying && !isPaused) {
                speechSynthesis.pause();
                isPaused = true;
                isPlaying = false;
            } else if (isPaused) {
                speechSynthesis.resume();
                isPaused = false;
                isPlaying = true;
            }
            updatePlayPauseButton();
        }

        // 新增更新播放/暂停按钮文本的函数
        function updatePlayPauseButton() {
            const playPauseButton = document.getElementById('playPause');
            if (isPlaying && !isPaused) {
                playPauseButton.textContent = '暂停';
            } else {
                playPauseButton.textContent = '播放';
            }
        }

        // 修改段落点击事件
        function setupParagraphListeners() {
            contentParagraphs = document.getElementById('content').getElementsByTagName('p');
            console.log("Setting up listeners for", contentParagraphs.length, "paragraphs");
            Array.from(contentParagraphs).forEach((paragraph, index) => {
                paragraph.addEventListener('click', () => {
                    console.log("Paragraph clicked:", index);
                    if (currentIndex !== index) {
                        currentIndex = index;
                        if (isPlaying) {
                            speechSynthesis.cancel();
                        }
                        speak(paragraph.textContent);
                    } else if (isPlaying) {
                        playPause();
                    } else {
                        speak(paragraph.textContent);
                    }
                });
            });
        }

        // 修改 playPause 按钮的事件监听器
        document.getElementById('playPause').addEventListener('click', () => {
            console.log("PlayPause button clicked");
            playPause();
        });

        document.getElementById('voiceSelect').addEventListener('change', () => {
            if (speech) {
                speechSynthesis.cancel();
                speak(contentParagraphs[currentIndex].textContent);
            }
        });

        document.getElementById('jumpToBookmark').addEventListener('click', jumpToBookmark);

        document.getElementById('speedControl').addEventListener('input', (event) => {
            currentSpeed = parseFloat(event.target.value);
            document.getElementById('speedValue').textContent = currentSpeed.toFixed(1) + 'x';
            localStorage.setItem('speechRate', currentSpeed);
            if (speech) {
                speech.rate = currentSpeed;
                speechSynthesis.cancel();
                speak(contentParagraphs[currentIndex].textContent);
            }
        });

        // 初始化速度控制
        document.getElementById('speedControl').value = currentSpeed;
        document.getElementById('speedValue').textContent = currentSpeed.toFixed(1) + 'x';

        // 在文档加载完成后初始化语音
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log("DOM content loaded");
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            // ... 其他初始化代码 ...
        });

        // 從 localStorage 恢復文件列表
        const savedFileList = JSON.parse(localStorage.getItem('fileList')) || [];
        if (savedFileList.length > 0) {
            fileList = savedFileList.map(f => new File([new Blob()], f.name, { lastModified: f.lastModified, type: 'text/plain' }));
            updateFileSelect();
        }

        // 如果有上次選擇的文件，自動選擇
        const lastSelectedFile = localStorage.getItem('lastSelectedFile');
        if (lastSelectedFile) {
            const fileIndex = fileList.findIndex(f => f.name === lastSelectedFile);
            if (fileIndex !== -1) {
                document.getElementById('fileSelect').value = fileIndex;
                const savedContent = localStorage.getItem('fileContent_' + lastSelectedFile);
                if (savedContent) {
                    document.getElementById('content').innerHTML = marked.parse(savedContent);
                    setupParagraphListeners();
                    updateBookmarkInfo();
                    currentFile = lastSelectedFile;
                } else {
                    document.getElementById('content').innerHTML = '请重新选择文件以加载内容。';
                }
            }
        }

        // 在脚本的末添加
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        });

        // 在页面加载时检查并应用夜间模式设置
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        let fontSize = parseInt(localStorage.getItem('fontSize')) || 18;
        
        function updateFontSize() {
            document.getElementById('content').style.fontSize = fontSize + 'px';
            localStorage.setItem('fontSize', fontSize);
        }

        document.getElementById('decreaseFont').addEventListener('click', () => {
            if (fontSize > 12) {
                fontSize -= 2;
                updateFontSize();
            }
        });

        document.getElementById('increaseFont').addEventListener('click', () => {
            if (fontSize < 30) {
                fontSize += 2;
                updateFontSize();
            }
        });

        // 在页面加载时应用保存的字体大小
        updateFontSize();

        // 添加或替换 loadContent 函数
        function loadContent(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = marked.parse(e.target.result);
                document.getElementById('content').innerHTML = content;
                setupParagraphListeners();
                
                const firstH1 = document.querySelector('#content h1');
                if (firstH1) {
                    document.title = firstH1.textContent;
                    document.getElementById('pageTitle').textContent = firstH1.textContent;
                }
                updateBookmarkInfo();
                
                // 保文件内容到 localStorage
                localStorage.setItem('fileContent_' + file.name, e.target.result);
            };
            reader.readAsText(file);
        }

        // 确保 setupParagraphListeners 函数被定义
        function setupParagraphListeners() {
            contentParagraphs = document.getElementById('content').getElementsByTagName('p');
            Array.from(contentParagraphs).forEach((paragraph, index) => {
                paragraph.addEventListener('click', () => {
                    currentIndex = index;
                    if (isPlaying) {
                        speechSynthesis.cancel();
                    }
                    speak(paragraph.textContent);
                    updatePlayPauseButton();
                });
            });
        }

        // 在文档加载完成后，尝试加载上次选择的文件
        document.addEventListener('DOMContentLoaded', (event) => {
            // ... 其他初始化代码 ...

            const lastSelectedFile = localStorage.getItem('lastSelectedFile');
            if (lastSelectedFile) {
                const fileIndex = fileList.findIndex(f => f.name === lastSelectedFile);
                if (fileIndex !== -1) {
                    document.getElementById('fileSelect').value = fileIndex;
                    const savedContent = localStorage.getItem('fileContent_' + lastSelectedFile);
                    if (savedContent) {
                        document.getElementById('content').innerHTML = marked.parse(savedContent);
                        setupParagraphListeners();
                        updateBookmarkInfo();
                        currentFile = lastSelectedFile;
                    } else {
                        document.getElementById('content').innerHTML = '请重新选择文件以加载内容。';
                    }
                }
            }
        });
    </script>
</body>
</html>